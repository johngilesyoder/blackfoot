!function($){$(function(){function e(e){$(".media-toolbar-secondary span.envira-gallery-spinner").css("visibility","visible"),$.post(envira_gallery_metabox.ajax,{action:"envira_gallery_load_library",offset:e,post_id:envira_gallery_metabox.id,search:$("input#envira-gallery-gallery-search").val(),nonce:envira_gallery_metabox.load_gallery},function(a){$("a.envira-gallery-load-library").attr("data-envira-gallery-offset",Number(e)+20),$(".media-toolbar-secondary span.envira-gallery-spinner").css("visibility","hidden"),0===e?$(".envira-gallery-gallery").html(a.html):$(".envira-gallery-gallery").append(a.html)},"json")}function a(){var e={action:"envira_gallery_refresh",post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.refresh_nonce};$(".envira-media-library").after('<span class="spinner envira-gallery-spinner envira-gallery-spinner-refresh"></span>'),$(".envira-gallery-spinner-refresh").css({display:"inline-block","margin-top":"-3px"}),$.post(envira_gallery_metabox.ajax,e,function(e){e&&e.success&&($("#envira-gallery-output").html(e.success),$("#envira-gallery-output").find(".wp-editor-wrap").each(function(e,a){var t=$(a).find(".quicktags-toolbar");if(!(t.length>0)){var n=$(a).attr("id").split("-"),i=n.slice(4,-1).join("-");quicktags({id:"envira-gallery-caption-"+i,buttons:"strong,em,link,ul,ol,li,close"}),QTags._buttonsInit()}}),$("#envira-gallery-output").trigger({type:"enviraRefreshed",html:e.success,id:envira_gallery_metabox.id})),$(".envira-gallery-spinner-refresh").fadeOut(300,function(){$(this).remove()})},"json")}function t(e){var a=$(e).data("envira-conditional").split(","),t=!1;switch($(e).attr("type")){case"checkbox":t=$(e).is(":checked");break;default:t=""==$(e).val()||0==$(e).val()?!1:!0}for(var n=0;n<a.length;n++)t?$("#"+a[n]).fadeIn(300):$("#"+a[n]).fadeOut(300)}0!==$(".envira-helper-needed").length&&$('<div class="envira-meta-helper-overlay" />').prependTo("#envira-gallery"),$(document).on("click",".envira-meta-icon",function(e){e.preventDefault();var a=$(this),t=a.parent(),n=a.next();n.is(":visible")?($(".envira-meta-helper-overlay").remove(),t.removeClass("envira-helper-active")):(0===$(".envira-meta-helper-overlay").length&&$('<div class="envira-meta-helper-overlay" />').prependTo("#envira-gallery"),t.addClass("envira-helper-active"))}),$(document).on("change",'input[name="_envira_gallery[type]"]:radio',function(e){var a=$(this);$(".envira-gallery-type-spinner .envira-gallery-spinner").css({display:"inline-block","margin-top":"-1px"});var t={action:"envira_gallery_change_type",post_id:envira_gallery_metabox.id,type:a.val(),nonce:envira_gallery_metabox.change_nonce};$.post(envira_gallery_metabox.ajax,t,function(e){"default"==e.type?$("#envira-gallery-main").html(e.html):$("#envira-gallery-main").html(e.html),$(document).trigger("enviraGalleryType",e),$(".envira-gallery-type-spinner .envira-gallery-spinner").hide()},"json")}),$(document).on("click",".envira-media-library",function(e){e.preventDefault(),u=!0,$("#envira-gallery-upload-ui").appendTo("body").show()});var n=!1;$(document).on("keyup keydown",function(e){n=e.shiftKey});var i;$(".envira-gallery-gallery").on("click",".thumbnail, .check, .media-modal-icon",function(e){e.preventDefault();var a=$(this).parent().parent();if(!$(a).hasClass("envira-gallery-in-gallery")){if($(a).hasClass("selected"))$(a).removeClass("details selected"),$('div.selection-view ul li[data-attachment-id="'+$(a).attr("data-attachment-id")+'"]').remove();else{if($(a).addClass("details selected"),$(a).clone().appendTo($("div.selection-view ul")).removeClass("details selected"),n===!0&&$(".envira-gallery-gallery li.selected").not(".envira-gallery-in-gallery").length>1)for(var t=$("li.attachment[data-attachment-id='"+i+"']"),l=!1;!l;)t=$(t).next(),$(t).data("attachment-id")===$(a).data("attachment-id")&&(l=!0),$(t).addClass("details selected"),$(t).clone().appendTo($("div.selection-view ul")).removeClass("details selected");i=$(a).data("attachment-id")}var r=$(".envira-gallery-gallery li.selected").not(".envira-gallery-in-gallery").length;$("div.media-modal span.count span.number").text(r)}}),$("div.media-modal").on("click","a.clear-selection",function(e){var a=$(".media-router a.active").data("envira-gallery-content");$("#envira-gallery-"+a+" li.selected").not(".envira-gallery-in-gallery").removeClass("details selected"),$("div.selection-view ul li").remove(),$("div.media-modal span.count span.number").text("0")}),$(document).on("click","a.envira-gallery-load-library",function(a){e($("a.envira-gallery-load-library").attr("data-envira-gallery-offset"))}),$(".envira-gallery-gallery").bind("scroll",function(){$(this).scrollTop()+$(this).innerHeight()>=this.scrollHeight&&e($("a.envira-gallery-load-library").attr("data-envira-gallery-offset"))}),$(document).on("keyup keydown","#envira-gallery-gallery-search",function(){v(function(){e(0)})}),$(document).on("click",".envira-gallery-media-insert",function(e){e.preventDefault();var a=$(this),t=$(this).text(),n={action:"envira_gallery_insert_images",nonce:envira_gallery_metabox.insert_nonce,post_id:envira_gallery_metabox.id,images:{}},i=!1,l=e;a.text(envira_gallery_metabox.inserting),$(".envira-gallery-media-frame .media-router a").each(function(){if("select-images"==$(this).data("envira-gallery-content"))$(".envira-gallery-media-frame").find(".attachment.selected:not(.envira-gallery-in-gallery)").each(function(e,a){n.images[e]=$(a).attr("data-attachment-id"),i=!0});else{var e=$(this).data("envira-gallery-content"),a=$("#envira-gallery-"+e);n[e]={},$("ul.attachments",$(a)).length>0?$(a).find(".attachment.selected").each(function(a,t){n[e][a]=$(t).attr("data-attachment-id")}):$(a).find(".envira-gallery-form-fields").each(function(a,t){n[e][a]={},$("input,select,textarea",$(this)).each(function(t){n[e][a][$(this).attr("class")]=$(this).val()})})}}),$.post(envira_gallery_metabox.ajax,n,function(e){setTimeout(function(){m(l),a.text(t),i&&$(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click")},500)},"json")}),$(document).on("click",".envira-gallery-media-frame .media-menu-item",function(e){e.preventDefault();var a=$(this),t=a.parent().find(".active").removeClass("active").data("envira-gallery-content"),n=a.addClass("active").data("envira-gallery-content");$("#envira-gallery-"+t).hide(),$("#envira-gallery-"+n).show()});var l=$("#envira-gallery-output");l.sortable({containment:"#envira-gallery-output",items:"li",cursor:"move",forcePlaceholderSize:!0,placeholder:"dropzone",update:function(e,a){var t={url:envira_gallery_metabox.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"envira_gallery_sort_images",order:l.sortable("toArray").toString(),post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.sort},success:function(e){},error:function(e,a,t){}};$.ajax(t)}}),$("a.envira-gallery-images-delete").fadeOut(),$("ul#envira-gallery-output").on("click","li.envira-gallery-image > img",function(){var e=$(this).parent();$(e).hasClass("selected")?$(e).removeClass("selected"):$(e).addClass("selected"),$("ul#envira-gallery-output > li.selected").length>0?$("a.envira-gallery-images-delete").fadeIn():$("a.envira-gallery-images-delete").fadeOut()}),$("a.envira-gallery-images-delete").click(function(e){e.preventDefault();var a=confirm(envira_gallery_metabox.remove_multiple);if(!a)return!1;var t=[];$("ul#envira-gallery-output > li.selected").each(function(){t.push($(this).attr("id"))});var n={action:"envira_gallery_remove_images",attachment_ids:t,post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.remove_nonce};$.post(envira_gallery_metabox.ajax,n,function(e){$("ul#envira-gallery-output > li.selected").each(function(){$(this).fadeOut("normal",function(){$(this).remove()})}),$("a.envira-gallery-images-delete").fadeOut(),$(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click")},"json")}),$("#envira-gallery").on("click",".envira-gallery-remove-image",function(e){e.preventDefault();var a=confirm(envira_gallery_metabox.remove);if(a){var t=$(this).parent().attr("id"),n={action:"envira_gallery_remove_image",attachment_id:t,post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.remove_nonce};$.post(envira_gallery_metabox.ajax,n,function(e){$("#"+t).fadeOut("normal",function(){$(this).remove(),$(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click")})},"json")}});var r=[];$("#envira-gallery").on("click.enviraModify",".envira-gallery-modify-image",function(e){e.preventDefault();var a=$(this).parent().data("envira-gallery-image"),t="envira-gallery-meta-"+a;r=[],$("ul#envira-gallery-output li").each(function(){r.push($(this).data("envira-gallery-image"))}),s(a,t)}),$(document).on("click","button.left, button.right",function(e){e.preventDefault(),d();var a=$(this).attr("data-attachment-id"),t="envira-gallery-meta-"+a;s(a,t)});var o,s=function(e,a){o=$("#"+a).appendTo("body"),$(o).show(),$("button.left",$(o)).removeClass("disabled"),$("button.right",$(o)).removeClass("disabled");for(var t=-1,n=0;n<r.length;n++)if(r[n]==e){t=n;break}0==t?($("button.left",$(o)).addClass("disabled"),$("button.left",$(o)).attr("data-attachment-id",""),r.length>1?($("button.right",$(o)).removeClass("disabled"),$("button.right",$(o)).attr("data-attachment-id",r[t+1])):($("button.right",$(o)).addClass("disabled"),$("button.right",$(o)).attr("data-attachment-id",""))):t==r.length-1?($("button.left",$(o)).removeClass("disabled"),$("button.left",$(o)).attr("data-attachment-id",r[t-1]),$("button.right",$(o)).addClass("disabled"),$("button.right",$(o)).attr("data-attachment-id","")):($("button.left",$(o)).removeClass("disabled"),$("button.left",$(o)).attr("data-attachment-id",r[t-1]),$("button.right",$(o)).removeClass("disabled"),$("button.right",$(o)).attr("data-attachment-id",r[t+1])),$(document).on("click.enviraIframe",".media-modal-close, .media-modal-backdrop",function(e){e.preventDefault(),d()}),$(document).on("keydown.enviraIframe",function(e){27==e.keyCode&&d()})},d=function(){var e=$(o).attr("id"),a=e.split("-"),t=a[a.length-1];$("#"+e).appendTo("#"+t).hide(),u=!1,$(document).off("click.enviraLink")},c;$("div.media-modal-content div.query-results").hide(),$(document).on("keyup","div.media-modal-content input#wp-link-search",function(){var e=this;window.clearTimeout(c),c=window.setTimeout(function(){wpLink.searchInternalLinks.call(e)},500)}),$(document).on("click","div.media-modal-content div.query-results li",function(e){var a=$("input[type=hidden]",$(this)).val(),t=$(o).attr("id"),n=t.split("-"),i=n[n.length-1];$("input#envira-gallery-link-"+i).val(a),$(this).parent().html("").parent().hide()}),$("div.media-modal-content input#wp-link-search").change(function(){""==$(this).val()&&$(".query-results ul").html("")}),$(document).on("click","div.media-modal-content input#wp-link-search",function(){var e=this;window.clearTimeout(c),c=window.setTimeout(function(){""==$(e).val()&&$(".query-results ul").html("").parent().hide()},500)}),$(document).on("click",".envira-gallery-meta-submit",function(e){e.preventDefault();var a=$(this),t=a.text(),n=a.data("envira-gallery-item"),i="envira-gallery-meta-"+n,l={},r=$("span.settings-save-status span.spinner"),o=$("span.settings-save-status span.saved");a.text(envira_gallery_metabox.saving),a.attr("disabled","disabled"),$(r).show(),l.caption=$("#envira-gallery-meta-table-"+n).find('textarea[name="_envira_gallery[meta_caption]"]').val(),$("#envira-gallery-meta-table-"+n).find(":input").not(".ed_button").each(function(e,a){$(this).data("envira-meta")&&(l[$(this).data("envira-meta")]=$(this).val(),"checkbox"==$(this).attr("type")&&($(this).attr("checked")?l[$(this).data("envira-meta")]=$(this).val():l[$(this).data("envira-meta")]=0))});var s={action:"envira_gallery_save_meta",nonce:envira_gallery_metabox.save_nonce,attach_id:n,post_id:envira_gallery_metabox.id,meta:l};$.post(envira_gallery_metabox.ajax,s,function(e){a.text(t),a.attr("disabled",!1),$(r).fadeOut("slow",function(){$(o).fadeIn("fast",function(){setTimeout(function(){$(o).fadeOut("slow")},500)})})},"json")}),$("#envira-gallery-import-submit").on("click",function(e){$(this).next().css("display","inline-block"),0===$("#envira-config-import-gallery").val().length&&(e.preventDefault(),$(this).next().hide(),alert(envira_gallery_metabox["import"]))});var v=function(){var e=0;return function(a,t){clearTimeout(e),e=setTimeout(a,t)}}(),u=!1,m=function(e){e.preventDefault(),$("#envira-gallery-upload-ui").appendTo("#envira-gallery-upload-ui-wrapper").hide(),a(),u=!1};$(document).on("click","#envira-gallery-upload-ui .media-modal-close, #envira-gallery-upload-ui .media-modal-backdrop",m),$(document).on("keydown",function(e){27==e.keyCode&&u&&m(e)}),$("input[data-envira-conditional], select[data-envira-conditional]").each(function(){t(this)}),$("input[data-envira-conditional], select[data-envira-conditional]").change(function(){t(this)})})}(jQuery);